# çº¿ç¨‹æ± 

## å‰è¨€

æˆ‘ç›¸ä¿¡ï¼Œå·²ç»é˜…è¯»åˆ°è¿™é‡Œçš„å„ä½ï¼Œä¸ä¼šå¯¹â€œ*çº¿ç¨‹æ± *â€è¿™ä¸ªè¯æ„Ÿåˆ°é™Œç”Ÿã€‚å¤§éƒ¨åˆ†å¼€å‘è€…æ—©å°±è‡ªå·±ä½¿ç”¨ã€å­¦ä¹ ï¼Œä¹ƒè‡³å®ç°è¿‡çº¿ç¨‹æ± ã€‚é‚£ä¸å¦‚æˆ‘ä»¬å…ˆæ¥è¿›è¡Œä¸€ä¸‹åŸºç¡€çš„åè¯è§£é‡Šã€‚

- ***ä»€ä¹ˆå«çº¿ç¨‹æ± ï¼Ÿ***

â€œ**çº¿ç¨‹**â€æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œæ˜¯ CPU è°ƒåº¦çš„æœ€å°å•ä½ï¼Œä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€ç§æŠ½è±¡èµ„æºã€‚

â€œ**æ± **â€ï¼Ÿæ°´æ± è£…ç€æ°´ï¼Œçº¿ç¨‹æ± åˆ™æ˜¯è£…ç€çº¿ç¨‹ï¼Œæ˜¯ä¸€ç§æŠ½è±¡çš„æŒ‡ä»£ã€‚

æŠ½è±¡çš„æ¥è¯´ï¼Œå¯ä»¥å½“åšæ˜¯ä¸€ä¸ªæ± å­ä¸­å­˜æ”¾äº†ä¸€å †çº¿ç¨‹ï¼Œ**æ•…ç§°ä½œçº¿ç¨‹æ± **ã€‚ç®€è€Œè¨€ä¹‹ï¼Œçº¿ç¨‹æ± æ˜¯æŒ‡ä»£ä¸€ç»„**é¢„å…ˆåˆ›å»ºçš„**ã€**å¯ä»¥å¤ç”¨çš„çº¿ç¨‹é›†åˆ**ã€‚è¿™äº›çº¿ç¨‹ç”±çº¿ç¨‹æ± ç®¡ç†ï¼Œç”¨äºæ‰§è¡Œå¤šä¸ªä»»åŠ¡è€Œ**æ— éœ€é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯**çº¿ç¨‹ã€‚

```mermaid
graph TD
    subgraph çº¿ç¨‹æ± 
        çº¿ç¨‹1
        çº¿ç¨‹2
        çº¿ç¨‹3
        çº¿ç¨‹4
        çº¿ç¨‹5
        ...
    end

    ä»»åŠ¡é˜Ÿåˆ—[ä»»åŠ¡é˜Ÿåˆ—]
    è°ƒåº¦å™¨ --> çº¿ç¨‹1
    è°ƒåº¦å™¨ --> çº¿ç¨‹2
    è°ƒåº¦å™¨ --> çº¿ç¨‹3
    è°ƒåº¦å™¨ --> çº¿ç¨‹4
    è°ƒåº¦å™¨ --> çº¿ç¨‹5

    ä»»åŠ¡1 --> è°ƒåº¦å™¨
    ä»»åŠ¡2 --> è°ƒåº¦å™¨
    ä»»åŠ¡3 --> è°ƒåº¦å™¨
    ä»»åŠ¡4 --> è°ƒåº¦å™¨
    ä»»åŠ¡5 --> è°ƒåº¦å™¨
    ä»»åŠ¡6 --> è°ƒåº¦å™¨
    ä»»åŠ¡7 --> è°ƒåº¦å™¨

    çº¿ç¨‹1 --> æ‰§è¡Œä»»åŠ¡1[æ‰§è¡Œä»»åŠ¡1]
    çº¿ç¨‹2 --> æ‰§è¡Œä»»åŠ¡2[æ‰§è¡Œä»»åŠ¡2]
    çº¿ç¨‹3 --> æ‰§è¡Œä»»åŠ¡3[æ‰§è¡Œä»»åŠ¡3]
    çº¿ç¨‹4 --> æ‰§è¡Œä»»åŠ¡4[æ‰§è¡Œä»»åŠ¡4]
    çº¿ç¨‹5 --> æ‰§è¡Œä»»åŠ¡5[æ‰§è¡Œä»»åŠ¡5]

    æ‰§è¡Œä»»åŠ¡1 --> ä¼‘çœ 1[ä¼‘çœ ç­‰å¾…]
    æ‰§è¡Œä»»åŠ¡2 --> ä¼‘çœ 2[ä¼‘çœ ç­‰å¾…]
    æ‰§è¡Œä»»åŠ¡3 --> ä¼‘çœ 3[ä¼‘çœ ç­‰å¾…]
    æ‰§è¡Œä»»åŠ¡4 --> ä¼‘çœ 4[ä¼‘çœ ç­‰å¾…]
    æ‰§è¡Œä»»åŠ¡5 --> ä¼‘çœ 5[ä¼‘çœ ç­‰å¾…]

    ä»»åŠ¡6 --> è°ƒåº¦å™¨ --> å”¤é†’çº¿ç¨‹1[å”¤é†’çº¿ç¨‹1]
    å”¤é†’çº¿ç¨‹1 -.-> çº¿ç¨‹1
    çº¿ç¨‹1 --> æ‰§è¡Œä»»åŠ¡6[æ‰§è¡Œä»»åŠ¡6]
    æ‰§è¡Œä»»åŠ¡6 --> ä¼‘çœ 1

    ä»»åŠ¡7 --> è°ƒåº¦å™¨ --> å”¤é†’çº¿ç¨‹2[å”¤é†’çº¿ç¨‹2]
    å”¤é†’çº¿ç¨‹2 -.-> çº¿ç¨‹2
    çº¿ç¨‹2 --> æ‰§è¡Œä»»åŠ¡7[æ‰§è¡Œä»»åŠ¡7]
    æ‰§è¡Œä»»åŠ¡7 --> ä¼‘çœ 2

```

> è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„çº¿ç¨‹æ± ç»“æ„ã€‚çº¿ç¨‹æ± åŒ…å«ä¸€ä¸ª**ä»»åŠ¡é˜Ÿåˆ—**ï¼Œå½“æœ‰æ–°ä»»åŠ¡åŠ å…¥æ—¶ï¼Œè°ƒåº¦å™¨ä¼šå°†ä»»åŠ¡åˆ†é…ç»™çº¿ç¨‹æ± ä¸­çš„ç©ºé—²çº¿ç¨‹è¿›è¡Œæ‰§è¡Œã€‚çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡åä¼šè¿›å…¥**ä¼‘çœ çŠ¶æ€**ï¼Œç­‰å¾…**è°ƒåº¦å™¨**çš„ä¸‹ä¸€æ¬¡**å”¤é†’**ã€‚å½“æœ‰æ–°çš„ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼Œå¹¶ä¸”æœ‰çº¿ç¨‹å¤„äºä¼‘çœ çŠ¶æ€æ—¶ï¼Œè°ƒåº¦å™¨ä¼šå”¤é†’ä¼‘çœ çš„çº¿ç¨‹ï¼Œå¹¶åˆ†é…æ–°çš„ä»»åŠ¡ç»™å®ƒä»¬æ‰§è¡Œã€‚çº¿ç¨‹æ‰§è¡Œå®Œæ–°ä»»åŠ¡åï¼Œä¼šå†æ¬¡è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°æœ‰æ–°çš„ä»»åŠ¡åˆ°æ¥ï¼Œè°ƒåº¦å™¨**æ‰å¯èƒ½**ä¼šå†æ¬¡å”¤é†’å®ƒä»¬ã€‚
>
> å›¾ä¸­çº¿ç¨‹1 å°±æ˜¯è¢«è°ƒåº¦å™¨åˆ†é…äº†ä»»åŠ¡1ï¼Œæ‰§è¡Œå®Œæ¯•åä¼‘çœ ï¼Œç„¶è€Œæ–°ä»»åŠ¡çš„åˆ°æ¥è®©è°ƒåº¦å™¨å†æ¬¡å°†å®ƒå”¤é†’ï¼Œå»æ‰§è¡Œä»»åŠ¡6ï¼Œæ‰§è¡Œå®Œæ¯•åç»§ç»­ä¼‘çœ ã€‚

ä½¿ç”¨çº¿ç¨‹æ± çš„ç›Šå¤„æˆ‘ä»¬å·²ç»åŠ ç²—äº†ï¼Œç„¶è€Œè¿™å…¶å®å¹¶ä¸æ˜¯â€œ*çº¿ç¨‹æ± *â€ç‹¬æœ‰çš„ï¼Œä»»ä½•åˆ›å»ºå’Œé”€æ¯å­˜åœ¨è¾ƒå¤§å¼€é”€çš„è®¾æ–½ï¼Œéƒ½å¯ä»¥è¿›è¡Œæ‰€è°“çš„â€œ***æ± åŒ–***â€ã€‚

å¸¸è§çš„è¿˜æœ‰ï¼š**å¥—æ¥å­—è¿æ¥æ± **ã€**æ•°æ®åº“è¿æ¥æ± **ã€**å†…å­˜æ± **ã€**å¯¹è±¡æ± **ã€‚

---

äº†è§£ä»¥ä¸Šè¿™äº›åŸºç¡€æ¦‚å¿µæ˜¯ç¬¬ä¸€æ­¥ä¹Ÿæ˜¯æœ€åä¸€æ­¥ï¼Œéšç€æ°´å¹³çš„æå‡ï¼Œå¯¹è¿™äº›æ¦‚å¿µçš„ç†è§£ä¹Ÿä¼šé€æ¸æå‡ã€‚

## å¸‚é¢ä¸Šå¸¸è§çš„çº¿ç¨‹æ± 

åœ¨äº†è§£äº†çº¿ç¨‹æ± çš„åŸºæœ¬æ¦‚å¿µä¸è¿è¡Œé€»è¾‘åï¼Œæˆ‘ä»¬ä¸ç”¨ç€æ€¥å°±å°è¯•å®ç°ã€‚æˆ‘ä»¬å¯ä»¥å…ˆæ¥èŠä¸€èŠï¼Œä½¿ç”¨ä¸€ä¸‹å¸‚é¢ä¸Šå¸¸è§çš„é‚£äº› C++ çº¿ç¨‹æ± è®¾æ–½ï¼Œäº†è§£å®ƒä»¬æä¾›çš„åŠŸèƒ½ï¼Œæ¥å£è®¾è®¡çš„æ–¹å¼ã€‚

### `boost::asio::thread_pool`

[`boost::asio::thread_pool`](https://think-async.com/Asio/asio-1.11.0/doc/asio/reference/thread_pool.html) æ˜¯ [`Boost.Asio`](https://www.boost.org/doc/libs/1_85_0/doc/html/boost_asio.html) åº“æä¾›çš„ä¸€ç§çº¿ç¨‹æ± å®ç°ã€‚

> Asio æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„ C++ åº“ï¼Œç”¨äº**ç½‘ç»œ**å’Œä½çº§ I/O ç¼–ç¨‹ï¼Œä½¿ç”¨ **ç°ä»£C++** æ–¹æ³•ä¸ºå¼€å‘äººå‘˜æä¾›ä¸€è‡´çš„å¼‚æ­¥æ¨¡å‹ã€‚

ä½¿ç”¨æ–¹æ³•ï¼š

1. åˆ›å»ºçº¿ç¨‹æ± å¯¹è±¡ï¼ŒæŒ‡å®šæˆ–è®© Asio è‡ªåŠ¨å†³å®šçº¿ç¨‹æ•°é‡ã€‚

2. æäº¤ä»»åŠ¡ï¼šé€šè¿‡ [`boost::asio::post`](https://beta.boost.org/doc/libs/1_82_0/doc/html/boost_asio/reference/post.html) å‡½æ•°æ¨¡æ¿æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­ã€‚

3. é˜»å¡ï¼Œç›´åˆ°æ± ä¸­çš„çº¿ç¨‹å®Œæˆä»»åŠ¡ã€‚

```cpp
#include <boost/asio.hpp>
#include <iostream>

std::mutex m;

void print_task(int n) {
    std::lock_guard<std::mutex> lc{ m };
    std::cout << "Task " << n << " is running on thr: " <<
        std::this_thread::get_id() << '\n';
}

int main() {
    boost::asio::thread_pool pool{ 4 }; // åˆ›å»ºä¸€ä¸ªåŒ…å« 4 ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 

    for (int i = 0; i < 10; ++i) {
        boost::asio::post(pool, [i] { print_task(i); });
    }

    pool.join(); // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆ
}
```

> [è¿è¡Œ](https://godbolt.org/z/41445Kab5)æµ‹è¯•ã€‚

- åˆ›å»ºçº¿ç¨‹æ± æ—¶ï¼ŒæŒ‡å®šçº¿ç¨‹æ•°é‡ï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºå¯¹åº”æ•°é‡çš„çº¿ç¨‹ã€‚

- ä½¿ç”¨ `boost::asio::post` æäº¤ä»»åŠ¡ï¼Œä»»åŠ¡ä¼šè¢«æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚

- çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä¼šä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œï¼Œä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œçº¿ç¨‹ç»§ç»­å–ä¸‹ä¸€ä¸ªä»»åŠ¡æˆ–è€…ä¼‘çœ ã€‚

- è°ƒç”¨ join æ–¹æ³•ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å¹¶å…³é—­çº¿ç¨‹æ± ã€‚

å¦‚æœæˆ‘ä»¬ä¸è‡ªå·±æŒ‡æ˜çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ï¼Œé‚£ä¹ˆ Asio ä¼šæ ¹æ®å‡½æ•° [`default_thread_pool_size`](https://github.com/boostorg/asio/blob/44238d033e1503c694782925d647811380a067c2/include/boost/asio/impl/thread_pool.ipp#L53-L58) è®¡ç®—å¹¶è¿”å›ä¸€ä¸ª**çº¿ç¨‹æ± çš„é»˜è®¤çº¿ç¨‹æ•°é‡**ã€‚å®ƒæ ¹æ®ç³»ç»Ÿçš„ç¡¬ä»¶å¹¶å‘èƒ½åŠ›æ¥å†³å®šä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé€šå¸¸æ˜¯ç¡¬ä»¶å¹¶å‘èƒ½åŠ›çš„ä¸¤å€ã€‚

```cpp
inline long default_thread_pool_size()
{
  std::size_t num_threads = thread::hardware_concurrency() * 2;
  num_threads = num_threads == 0 ? 2 : num_threads;
  return static_cast<long>(num_threads);
}

thread_pool::thread_pool()
  : scheduler_(add_scheduler(new detail::scheduler(*this, 0, false))),
    num_threads_(detail::default_thread_pool_size())
```

ä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯ `thread::hardware_concurrency() * 2` è€Œå·²ï¼Œè‡³äºä¸‹é¢çš„åˆ¤æ–­æ˜¯å› ä¸º  `std::thread::hardware_concurrency()` åœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹å¯èƒ½è¿”å› `0`ï¼ˆä¾‹å¦‚ç¡¬ä»¶å¹¶å‘èƒ½åŠ›æ— æ³•è¢«æ£€æµ‹æ—¶ï¼‰ï¼Œé‚£é‚£å°† `num_threads` è®¾ç½®ä¸º 2ï¼Œç¡®ä¿çº¿ç¨‹æ± è‡³å°‘æœ‰ 2 ä¸ªçº¿ç¨‹ã€‚

---

Boost.Asio çš„çº¿ç¨‹æ± å¯¹è±¡åœ¨[ææ„](https://github.com/boostorg/asio/blob/44238d033e1503c694782925d647811380a067c2/include/boost/asio/impl/thread_pool.ipp#L98-L103)æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ç›¸å…³çš„æ¸…ç†æ–¹æ³•ï¼Œä½†ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨è¿›è¡Œæ§åˆ¶ã€‚

```cpp
thread_pool::~thread_pool()
{
  stop();     // åœæ­¢æ¥æ”¶æ–°ä»»åŠ¡
  join();     // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
  shutdown(); // æœ€ç»ˆæ¸…ç†ï¼Œé‡Šæ”¾èµ„æº
}
```

- `stop` ï¼šä¿®æ”¹å†…éƒ¨çš„æ ‡å¿—ä½å­˜åœ¨ä½¿å¾—çº¿ç¨‹æ± èƒ½å¤Ÿè¯†åˆ«ä½•æ—¶éœ€è¦åœæ­¢æ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œä»¥åŠå…³é—­è¿˜æ²¡å¼€å§‹æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç„¶åå”¤é†’æ‰€æœ‰çº¿ç¨‹ã€‚
- `join()` ï¼šç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆå®ƒä»¬çš„å·¥ä½œï¼Œç¡®ä¿æ‰€æœ‰çº¿ç¨‹éƒ½å·²ç»ˆæ­¢ã€‚
- `shutdown()` ï¼šè¿›è¡Œæœ€ç»ˆçš„æ¸…ç†ï¼Œé‡Šæ”¾èµ„æºï¼Œç¡®ä¿çº¿ç¨‹æ± çš„å®Œå…¨æ¸…ç†å’Œèµ„æºçš„æ­£ç¡®é‡Šæ”¾

> æ­¤å¤„å¯é˜…è¯»éƒ¨åˆ†æºç ï¼Œå¸®åŠ©ç†è§£ä¸è®°å¿†

ææ„å‡½æ•°å…ˆè°ƒç”¨äº† `stop()` ï¼Œç„¶åå†è¿›è¡Œ `join()` ã€‚é‚£å¦‚æœæˆ‘ä»¬æ²¡æœ‰æå‰æ˜¾å¼è°ƒç”¨ `join()` æˆå‘˜å‡½æ•°ï¼Œ**å¯èƒ½å¯¼è‡´ä¸€äº›ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œï¼Œææ„å‡½æ•°å¹¶ä¸ä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•**ï¼š

```cpp
boost::asio::thread_pool pool{ 4 }; 

for (int i = 0; i < 10; ++i) {
    boost::asio::post(pool, [i] { print_task(i); });
}
```

> [è¿è¡Œ](https://godbolt.org/z/MPoxrY9Yo)æµ‹è¯•ã€‚

å› ä¸ºææ„å‡½æ•°å¹¶ä¸æ˜¯é˜»å¡ç›´åˆ°æ‰§è¡Œå®Œæ‰€æœ‰ä»»åŠ¡ï¼Œè€Œæ˜¯å…ˆ**åœæ­¢**ï¼Œå† `join()` ä»¥åŠ `shutdown()`ã€‚

`Boost.Asio` æä¾›çš„çº¿ç¨‹æ± ä½¿ç”¨ååˆ†ç®€å•ï¼Œæ¥å£é«˜åº¦å°è£…ï¼Œå‡ ä¹æ— éœ€å…³å¿ƒåº•å±‚å…·ä½“å®ç°ï¼Œæ˜“äºä½¿ç”¨ã€‚

æˆ‘ä»¬çš„æ“ä½œå‡ ä¹åªéœ€åˆ›å»ºçº¿ç¨‹æ± å¯¹è±¡ã€å°†ä»»åŠ¡åŠ å…¥çº¿ç¨‹æ± ã€åœ¨éœ€è¦æ—¶è°ƒç”¨ `join()`ã€‚

```cpp
boost::asio::thread_pool pool{4};  // åˆ›å»ºçº¿ç¨‹æ± 
boost::asio::post(pool, task);     // å°†ä»»åŠ¡åŠ å…¥çº¿ç¨‹æ± 
pool.join();                       // ç­‰å¾…ä»»åŠ¡å®Œæˆ ï¼ˆæˆ–è€…ææ„è‡ªåŠ¨è°ƒç”¨ï¼‰
```

### `QThreadPool`

[`QThreadPool`](https://doc.qt.io/qt-6/qthreadpool.html) æ˜¯ Qt æä¾›çš„çº¿ç¨‹æ± å®ç°ï¼Œå®ƒæ˜¯ç”¨æ¥ç®¡ç†è‡ªå®¶çš„ `QThreads` çš„é›†åˆã€‚

```cpp
#include <QCoreApplication>
#include <QThreadPool>
#include <QRunnable>
#include <QDebug>

struct MyTask : public QRunnable{
    void run() override {
        qDebug() << "ğŸ¢ğŸ¢ğŸ¢ğŸ¢ğŸ¢";
    }
};

int main(int argc, char *argv[]){
    QCoreApplication app(argc, argv);

    QThreadPool *threadPool = QThreadPool::globalInstance();

    // çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°
    qDebug()<< threadPool->maxThreadCount();

    for (int i = 0; i < 10; ++i) {
        MyTask *task = new MyTask{};
        threadPool->start(task);
    }
    // å½“å‰æ´»è·ƒçº¿ç¨‹æ•° 10
    qDebug()<<threadPool->activeThreadCount();

    app.exec();
}
```

ä¸ `Asio.thread_pool` ä¸åŒï¼Œ`QThreadPool` é‡‡ç”¨å•ä¾‹æ¨¡å¼ï¼Œé€šè¿‡é™æ€æˆå‘˜å‡½æ•° `QThreadPool::globalInstance()` è·å–å¯¹è±¡å®ä¾‹ï¼ˆä¸è¿‡ä¹Ÿå¯ä»¥è‡ªå·±åˆ›å»ºï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ`QThreadPool` çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°ä¸ºå½“å‰ç¡¬ä»¶æ”¯æŒçš„å¹¶å‘çº¿ç¨‹æ•°ï¼Œä¾‹å¦‚åœ¨æˆ‘çš„ç¡¬ä»¶ä¸Šä¸º `20`ï¼Œè¿™ç‚¹ä¹Ÿå’Œ `Asio.thread_pool` ä¸åŒã€‚

`QThreadPool` ä¾èµ–äº Qt çš„äº‹ä»¶å¾ªç¯ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨äº† `QCoreApplication`ã€‚

è€Œå°†ä»»åŠ¡æ·»åŠ åˆ°çº¿ç¨‹æ± ä¸­çš„åšæ³•éå¸¸å¤è€åŸå§‹ï¼Œæˆ‘ä»¬éœ€è¦**è‡ªå®šä¹‰ä¸€ä¸ªç±»å‹ç»§æ‰¿å¹¶é‡å†™è™šå‡½æ•° `run`**ï¼Œåˆ›å»ºä»»åŠ¡å¯¹è±¡ï¼Œç„¶åå°†ä»»åŠ¡å¯¹è±¡ä¼ é€’ç»™çº¿ç¨‹æ± çš„ `start` æ–¹æ³•ã€‚

> è¿™ç§æ–¹æ³•è¿‡äºåŸå§‹ï¼Œå¦‚æœè¯»è€…å­¦è¿‡ `java` ç›¸ä¿¡ä¹Ÿä¸ä¼šé™Œç”Ÿã€‚æˆ‘ä»¬å®ç°çš„çº¿ç¨‹æ± ä¸ä¼šæ˜¯å¦‚æ­¤ã€‚

åœ¨ Qt6ï¼Œå¼•å…¥äº†ä¸€ä¸ª [`start`](https://doc.qt.io/qt-6/qthreadpool.html#start-1) çš„é‡è½½ç‰ˆæœ¬ï¼š

```cpp
template <typename Callable, QRunnable::if_callable<Callable>>
void QThreadPool::start(Callable &&functionToRun, int priority)
{
    start(QRunnable::create(std::forward<Callable>(functionToRun)), priority);
}
```

å®ƒç›¸å½“äºæ˜¯å¯¹[`start` åŸå§‹ç‰ˆæœ¬](https://doc.qt.io/qt-5/qthreadpool.html#start)çš„ï¼š

```cpp
void start(QRunnable *runnable, int priority = 0);
```

> [æºç ](https://codebrowser.dev/qt6/qtbase/src/corelib/thread/qthreadpool.cpp.html#_ZN11QThreadPool5startEP9QRunnablei)ã€‚

è¿›è¡Œçš„ä¸€ä¸ª**åŒ…è£…**ï¼Œä»¥æ”¯æŒä»»ä½•çš„[*å¯è°ƒç”¨(*Callable*)*](https://zh.cppreference.com/w/cpp/named_req/Callable)ç±»å‹ï¼Œè€Œæ— éœ€å†ç¹ççš„ç»§æ‰¿é‡å†™ `run` å‡½æ•°ã€‚

```cpp
threadPool->start([=]{
    qDebug()<<QString("thread id %1").arg(i);
});
```

---

`QThradPool` è¿˜æ”¯æŒæ‰‹åŠ¨æ§åˆ¶[**ä»»åŠ¡ä¼˜å…ˆçº§**](https://doc.qt.io/qt-6/qthread.html#Priority-enum)ã€‚é€šè¿‡è°ƒç”¨ `start` æˆå‘˜å‡½æ•°ï¼Œå°†ä»»åŠ¡ä¼ é€’ç»™çº¿ç¨‹æ± åå¯ä»¥å†æŒ‡æ˜æ‰§è¡Œç­–ç•¥ã€‚

 [`enum QThread::Priority`](https://codebrowser.dev/qt6/qtbase/src/corelib/thread/qthread.h.html#QThread::Priority) æšä¸¾ç±»å‹è¡¨ç¤ºæ“ä½œç³»ç»Ÿ**åº”å¦‚ä½•è°ƒåº¦æ–°åˆ›å»ºçš„çº¿ç¨‹**ã€‚

| å¸¸é‡                            |  å€¼  | æè¿°                                       |
| :------------------------------ | :--: | -----------------------------------------|
| `QThread::IdlePriority`         |  0   | ä»…åœ¨æ²¡æœ‰å…¶ä»–çº¿ç¨‹è¿è¡Œæ—¶è°ƒåº¦ã€‚                  |
| `QThread::LowestPriority`       |  1   | è°ƒåº¦é¢‘ç‡ä½äº LowPriorityã€‚                  |
| `QThread::LowPriority`          |  2   | è°ƒåº¦é¢‘ç‡ä½äº NormalPriorityã€‚               |
| `QThread::NormalPriority`       |  3   | æ“ä½œç³»ç»Ÿçš„é»˜è®¤ä¼˜å…ˆçº§ã€‚                       |
| `QThread::HighPriority`         |  4   | è°ƒåº¦é¢‘ç‡é«˜äº NormalPriorityã€‚               |
| `QThread::HighestPriority`      |  5   | è°ƒåº¦é¢‘ç‡é«˜äº HighPriorityã€‚                 |
| `QThread::TimeCriticalPriority` |  6   | å°½å¯èƒ½é¢‘ç¹åœ°è°ƒåº¦ã€‚                           |
| `QThread::InheritPriority`      |  7   | ä½¿ç”¨ä¸åˆ›å»ºçº¿ç¨‹ç›¸åŒçš„ä¼˜å…ˆçº§ã€‚ è¿™æ˜¯é»˜è®¤å€¼ã€‚        |

åˆ°æ­¤ä¹Ÿå°±è¶³å¤Ÿäº†ï¼Œè™½ç„¶è¿˜æœ‰ä¸å°‘æ¥å£æ²¡æœ‰ä»‹ç»ï¼Œä¸è¿‡ä¹Ÿéƒ½æ²¡ä»€ä¹ˆç‰¹åˆ«çš„äº†ã€‚

## å®ç°çº¿ç¨‹æ± 

å®ç°ä¸€ä¸ªæ™®é€šçš„èƒ½å¤Ÿæ»¡è¶³æ—¥å¸¸å¼€å‘éœ€æ±‚çš„çº¿ç¨‹æ± å®é™…ä¸Šéå¸¸ç®€å•ï¼Œåªéœ€è¦ä¸åˆ°ä¸€ç™¾è¡Œä»£ç ã€‚

> - â€œ*æ™®é€šçš„èƒ½å¤Ÿæ»¡è¶³æ—¥å¸¸å¼€å‘éœ€*æ±‚çš„â€
>
>   å…¶å®ç»å¤§éƒ¨åˆ†å¼€å‘è€…ä½¿ç”¨çº¿ç¨‹æ± ï¼Œåªæ˜¯ä¸ºäº†ä¸é‡å¤å¤šæ¬¡åˆ›å»ºçº¿ç¨‹ç½¢äº†ã€‚æ‰€ä»¥åªéœ€è¦ä¸€ä¸ªæä¾›ä¸€ä¸ªå¤–éƒ¨æ¥å£ï¼Œå¯ä»¥ä¼ å…¥ä»»åŠ¡åˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åå®‰æ’çº¿ç¨‹å»æ‰§è¡Œã€‚æ— éæ˜¯ä½¿ç”¨æ¡ä»¶å˜é‡ã€äº’æ–¥é‡ã€åŸå­æ ‡å¿—ä½ï¼Œè¿™äº›ä¸œè¥¿ï¼Œå°±è¶³å¤Ÿç¼–å†™ä¸€ä¸ªæ»¡è¶³ç»å¤§éƒ¨åˆ†ä¸šåŠ¡éœ€æ±‚çš„çº¿ç¨‹æ± ã€‚

æˆ‘ä»¬å…ˆç¼–å†™ä¸€ä¸ª**æœ€åŸºç¡€çš„**çº¿ç¨‹æ± ï¼Œé¦–å…ˆç¡®å®šå®ƒçš„æ•°æ®æˆå‘˜ï¼š

```cpp
class ThreadPool {
    std::mutex                mutex_;
    std::condition_variable   cv_;
    std::atomic<bool>         stop_;
    std::atomic<std::size_t>  num_threads_;
    std::queue<Task>          tasks_;
    std::vector<std::thread>  pool_;
};
```

1. **`std::mutex mutex_`**
   - ç”¨äºä¿æŠ¤å…±äº«èµ„æºï¼ˆå¦‚ä»»åŠ¡é˜Ÿåˆ—ï¼‰åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­çš„è®¿é—®ï¼Œé¿å…æ•°æ®ç«äº‰ã€‚

2. **`std::condition_variable cv_`**
   - ç”¨äºçº¿ç¨‹é—´çš„åŒæ­¥ï¼Œå…è®¸çº¿ç¨‹ç­‰å¾…ç‰¹å®šæ¡ä»¶ï¼ˆå¦‚æ–°ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼‰å¹¶åœ¨æ¡ä»¶æ»¡è¶³æ—¶å”¤é†’çº¿ç¨‹ã€‚

3. **`std::atomic<bool> stop_`**
   - æŒ‡ç¤ºçº¿ç¨‹æ± æ˜¯å¦åœæ­¢ã€‚

4. **`std::atomic<std::size_t> num_threads_`**
   - è¡¨ç¤ºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ã€‚

5. **`std::queue<Task> tasks_`**
   - ä»»åŠ¡é˜Ÿåˆ—ï¼Œå­˜å‚¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä»»åŠ¡æŒ‰æäº¤é¡ºåºæ‰§è¡Œã€‚

6. **`std::vector<std::thread> pool_`**

   - çº¿ç¨‹å®¹å™¨ï¼Œå­˜å‚¨ç®¡ç†çº¿ç¨‹å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡å¹¶æ‰§è¡Œã€‚

**æ ‡å¤´ä¾èµ–**ï¼š

```cpp
#include <iostream>
#include <thread>
#include <mutex>
#include <condition_variable>
#include <future>
#include <atomic>
#include <queue>
#include <vector>
#include <syncstream>
#include <functional>
```

æä¾›æ„é€ ææ„å‡½æ•°ï¼Œä»¥åŠä¸€äº›å¤–éƒ¨æ¥å£ï¼š`submit()`ã€`start()`ã€`stop()`ã€`join()`ï¼Œä¹Ÿå°±å®Œæˆäº†ï¼š

```cpp
inline std::size_t default_thread_pool_size()noexcept {
    std::size_t num_threads = std::thread::hardware_concurrency() * 2;
    num_threads = num_threads == 0 ? 2 : num_threads;
    return num_threads;
}

class ThreadPool {
public:
    using Task = std::packaged_task<void()>;

    ThreadPool(const ThreadPool&) = delete;
    ThreadPool& operator=(const ThreadPool&) = delete;

    ThreadPool(std::size_t num_thread = default_thread_pool_size())
        : stop_{ false }, num_threads_{ num_thread } {
        start();
    }

    ~ThreadPool() {
        stop();
    }

    void stop() {
        stop_.store(true);
        cv_.notify_all();
        for (auto& thread : pool_) {
            if (thread.joinable()) {
                thread.join();
            }
        }
        pool_.clear();
    }

    template<typename F, typename... Args>
    std::future<std::invoke_result_t<std::decay_t<F>, std::decay_t<Args>...>> submit(F&& f, Args&&...args) {
        using RetType = std::invoke_result_t<std::decay_t<F>, std::decay_t<Args>...>;
        if (stop_.load()) {
            throw std::runtime_error("ThreadPool is stopped");
        }

        auto task = std::make_shared<std::packaged_task<RetType()>>(
            std::bind(std::forward<F>(f), std::forward<Args>(args)...));
        std::future<RetType> ret = task->get_future();

        {
            std::lock_guard<std::mutex> lc{ mutex_ };
            tasks_.emplace([task] {(*task)(); });
        }
        cv_.notify_one();
        return ret;
    }

    void start() {
        for (std::size_t i = 0; i < num_threads_; ++i) {
            pool_.emplace_back([this] {
                while (!stop_) {
                    Task task;
                    {
                        std::unique_lock<std::mutex> lc{ mutex_ };
                        cv_.wait(lc, [this] {return stop_ || !tasks_.empty(); });
                        if (tasks_.empty())
                            return;
                        task = std::move(tasks_.front());
                        tasks_.pop();
                    }
                    task();
                }
            });
        }
    }

private:
    std::mutex                mutex_;
    std::condition_variable   cv_;
    std::atomic<bool>         stop_;
    std::atomic<std::size_t>  num_threads_;
    std::queue<Task>          tasks_;
    std::vector<std::thread>  pool_;
};
```

**æµ‹è¯• demo**ï¼š

```cpp
int main() {
    ThreadPool pool{ 4 }; // åˆ›å»ºä¸€ä¸ªæœ‰ 4 ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 
    std::vector<std::future<int>> futures; // future é›†åˆï¼Œè·å–è¿”å›å€¼

    for (int i = 0; i < 10; ++i) {
        futures.emplace_back(pool.submit(print_task, i));
    }

    for (int i = 0; i < 10; ++i) {
        futures.emplace_back(pool.submit(print_task2, i));
    }

    int sum = 0;
    for (auto& future : futures) {
        sum += future.get(); // get() æˆå‘˜å‡½æ•° é˜»å¡åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè·å–è¿”å›å€¼
    }
    std::cout << "sum: " << sum << '\n';
} // ææ„è‡ªåŠ¨ stop() 
```

**å¯èƒ½çš„[è¿è¡Œç»“æœ](https://godbolt.org/z/n7Tana59x)**ï¼š

```shell
Task 0 is running on thr: 6900
Task 1 is running on thr: 36304
Task 5 is running on thr: 36304
Task 3 is running on thr: 6900
Task 7 is running on thr: 6900
Task 2 is running on thr: 29376
Task 6 is running on thr: 36304
Task 4 is running on thr: 31416
ğŸ¢ğŸ¢ğŸ¢ 1 ğŸ‰ğŸ‰ğŸ‰
Task 9 is running on thr: 29376
ğŸ¢ğŸ¢ğŸ¢ 0 ğŸ‰ğŸ‰ğŸ‰
Task 8 is running on thr: 6900
ğŸ¢ğŸ¢ğŸ¢ 2 ğŸ‰ğŸ‰ğŸ‰
ğŸ¢ğŸ¢ğŸ¢ 6 ğŸ‰ğŸ‰ğŸ‰
ğŸ¢ğŸ¢ğŸ¢ 4 ğŸ‰ğŸ‰ğŸ‰
ğŸ¢ğŸ¢ğŸ¢ 5 ğŸ‰ğŸ‰ğŸ‰
ğŸ¢ğŸ¢ğŸ¢ 3 ğŸ‰ğŸ‰ğŸ‰
ğŸ¢ğŸ¢ğŸ¢ 7 ğŸ‰ğŸ‰ğŸ‰
ğŸ¢ğŸ¢ğŸ¢ 8 ğŸ‰ğŸ‰ğŸ‰
ğŸ¢ğŸ¢ğŸ¢ 9 ğŸ‰ğŸ‰ğŸ‰
sum: 90
```

> å¦‚æœç­‰å¾…çº¿ç¨‹æ± å¯¹è±¡è°ƒç”¨ææ„å‡½æ•°ï¼Œé‚£ä¹ˆæ•ˆæœå¦‚åŒ `asio::thread_pool`ï¼Œä¼šå…ˆè¿›è¡Œ `stop`ï¼Œè¿™å¯èƒ½å¯¼è‡´ä¸€äº›ä»»åŠ¡æ— æ³•æ‰§è¡Œã€‚ä¸è¿‡æˆ‘ä»¬åœ¨æœ€å**å¾ªç¯éå†äº† `futures`**ï¼Œè°ƒç”¨ `get()` æˆå‘˜å‡½æ•°ï¼Œä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚

å®ƒæ”¯æŒ**ä»»æ„å¯è°ƒç”¨ç±»å‹**ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬éé™æ€æˆå‘˜å‡½æ•°ã€‚æˆ‘ä»¬ä½¿ç”¨äº† [`std::decay_t`](https://zh.cppreference.com/w/cpp/types/decay)ï¼Œæ‰€ä»¥å‚æ•°çš„ä¼ é€’å…¶å®æ˜¯**æŒ‰å€¼å¤åˆ¶**ï¼Œè€Œä¸æ˜¯å¼•ç”¨ä¼ é€’ï¼Œè¿™ä¸€ç‚¹å’Œå¤§éƒ¨åˆ†åº“çš„è®¾è®¡ä¸€è‡´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

```cpp
struct X {
    void f(const int& n) const {
        std::osyncstream{ std::cout } << &n << '\n';
    }
};

int main() {
    ThreadPool pool{ 4 }; // åˆ›å»ºä¸€ä¸ªæœ‰ 4 ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 

    X x;
    int n = 6;
    std::cout << &n << '\n';
    auto t = pool.submit(&X::f, &x, n); // é»˜è®¤å¤åˆ¶ï¼Œåœ°å€ä¸åŒ
    auto t2 = pool.submit(&X::f, &x, std::ref(n));
    t.wait();
    t2.wait();
} // ææ„è‡ªåŠ¨ stop()
```

> [è¿è¡Œ](https://godbolt.org/z/vY458T44e)æµ‹è¯•ã€‚

æˆ‘ä»¬çš„çº¿ç¨‹æ± çš„ `submit` æˆå‘˜å‡½æ•°åœ¨ä¼ é€’å‚æ•°çš„è¡Œä¸ºä¸Šï¼Œä¸å…ˆå‰ä»‹ç»çš„ `std::thread` å’Œ `std::async` ç­‰è®¾æ–½åŸºæœ¬ä¸€è‡´ã€‚

æˆ‘ä»¬ç¨å¾®ä»‹ç»çº¿ç¨‹æ± çš„æ¥å£ï¼š

 **æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ï¼š**

- **æ„é€ å‡½æ•°**ï¼šåˆå§‹åŒ–çº¿ç¨‹æ± å¹¶**å¯åŠ¨çº¿ç¨‹**ã€‚

- **ææ„å‡½æ•°**ï¼šåœæ­¢çº¿ç¨‹æ± å¹¶ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸã€‚

**å¤–éƒ¨æ¥å£ï¼š**

- **`stop()`**ï¼šåœæ­¢çº¿ç¨‹æ± ï¼Œé€šçŸ¥æ‰€æœ‰çº¿ç¨‹é€€å‡ºï¼ˆä¸ä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼‰ã€‚
- **`submit()`**ï¼šå°†ä»»åŠ¡æäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¹¶è¿”å›ä¸€ä¸ª`std::future`å¯¹è±¡ç”¨äºè·å–ä»»åŠ¡ç»“æœä»¥åŠç¡®ä¿ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚
- **`start()`**ï¼šå¯åŠ¨çº¿ç¨‹æ± ï¼Œåˆ›å»ºå¹¶å¯åŠ¨æŒ‡å®šæ•°é‡çš„çº¿ç¨‹ã€‚

æˆ‘ä»¬å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æ‰€è°“çš„â€œ***è°ƒåº¦å™¨***â€ï¼Œæˆ‘ä»¬åªæ˜¯åˆ©ç”¨æ¡ä»¶å˜é‡å’Œäº’æ–¥é‡ï¼Œè®©æ“ä½œç³»ç»Ÿè‡ªè¡Œè°ƒåº¦è€Œå·²ï¼Œå®ƒå¹¶ä¸å…·å¤‡è®¾ç½®ä»»åŠ¡ä¼˜å…ˆçº§ä¹‹ç±»çš„è°ƒåº¦åŠŸèƒ½ã€‚

å½“ç„¶ï¼Œä½ å¯èƒ½è¿˜å¸Œæœ›æˆ‘ä»¬çš„çº¿ç¨‹æ± å…·å¤‡æ›´å¤šåŠŸèƒ½æˆ–æ”¹è¿›ï¼Œæ¯”å¦‚æ§åˆ¶ä»»åŠ¡ä¼˜å…ˆçº§ã€è®¾ç½®æœ€å¤§çº¿ç¨‹æ•°é‡ã€è¿”å›å½“å‰æ´»è·ƒçº¿ç¨‹æ•°ç­‰ã€‚æ­¤å¤–ï¼Œå¼‚å¸¸å¤„ç†ä¹Ÿæ˜¯ä¸€ä¸ªå€¼å¾—è€ƒè™‘çš„æ–¹é¢ã€‚

æœ‰äº›åŠŸèƒ½å®ç°èµ·æ¥éå¸¸ç®€å•ï¼Œè€Œæœ‰äº›åˆ™éœ€è¦æ›´å¤šçš„æ€è€ƒå’Œè®¾è®¡ã€‚ä¸è¿‡ï¼Œè¿™äº›åŠŸèƒ½è¶…å‡ºäº†æœ¬æ¬¡è®²è§£çš„èŒƒå›´ã€‚å¦‚æœæœ‰å…´è¶£ï¼Œå¯ä»¥å°è¯•è‡ªè¡Œä¼˜åŒ–æˆ‘ä»¬æä¾›çš„çº¿ç¨‹æ± å®ç°ï¼Œæ·»åŠ æ›´å¤šçš„åŠŸèƒ½ã€‚æˆ‘ä»¬ç»™å‡ºçš„çº¿ç¨‹æ± å®ç°ç®€å•å®Œå–„ä¸”ç›´è§‚ï¼Œç”¨æ¥å­¦ä¹ å†å¥½ä¸è¿‡ã€‚

## æ€»ç»“

åœ¨æœ¬ç« ä¸­æˆ‘ä»¬è¯¦ç»†çš„ä»‹ç»äº†ï¼š

- çº¿ç¨‹æ± çš„åŸºæœ¬æ¦‚å¿µã€‚

- å¸‚é¢ä¸Šå¸¸è§çš„çº¿ç¨‹æ± çš„è®¾è®¡ä¸ä½¿ç”¨ï¼Œ `boost::asio::thread_pool`ã€`QThreadPool`ã€‚
- å®ç°ä¸€ä¸ªç®€æ˜“çš„çº¿ç¨‹æ± ã€‚

æ€»ä½“è€Œè¨€ï¼Œå†…å®¹å¹¶ä¸æ„æˆå¤ªå¤§çš„éš¾åº¦ã€‚

**è¯¾åä½œä¸š**ï¼šè‡ªå·±å®ç°ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä»¬ç»™å‡ºçš„çº¿ç¨‹æ± å®ç°å¢åŠ åŠŸèƒ½ï¼Œæäº¤åˆ° `homework` æ–‡ä»¶å¤¹ä¸­ã€‚
