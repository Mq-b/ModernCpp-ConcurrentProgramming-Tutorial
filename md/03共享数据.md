# å…±äº«æ•°æ®

æœ¬ç« èŠ‚ä¸»è¦å†…å®¹ï¼š

- åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œå…±äº«æ•°æ®ä¸ºä»€ä¹ˆä¼šæœ‰é—®é¢˜ï¼Ÿ

- ä½¿ç”¨äº’æ–¥é‡æ¥ä¿æŠ¤å…±äº«æ•°æ®ã€‚

åœ¨ä¸Šä¸€ç« å†…å®¹ï¼Œæˆ‘ä»¬å¯¹äºçº¿ç¨‹çš„åŸºæœ¬ä½¿ç”¨å’Œç®¡ç†ï¼Œå¯ä»¥è¯´å·²ç»æ¯”è¾ƒäº†è§£äº†ï¼Œç”šè‡³æ·±å…¥é˜…è¯»äº†éƒ¨åˆ†çš„ `std::thread` æºç ã€‚æ‰€ä»¥å¦‚æœä½ å¥½å¥½å­¦ä¹ äº†ä¸Šä¸€ç« ï¼Œæœ¬ç« ä¹Ÿå®Œå…¨ä¸ç”¨æ‹…å¿ƒï¼Œå®ƒç”šè‡³æ˜¯æ›´åŠ ç®€å•çš„ã€‚

æˆ‘ä»¬æœ¬èŠ‚ï¼Œå°±è¦å¼€å§‹èŠå…±äº«æ•°æ®çš„é‚£äº›äº‹ã€‚

## æ¡ä»¶ç«äº‰

åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æŠ¢ç€å®Œæˆè‡ªå·±çš„ä»»åŠ¡ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå³ä½¿ä¼šæ”¹å˜æ‰§è¡Œé¡ºåºï¼Œä¹Ÿæ˜¯è‰¯æ€§ç«äº‰ï¼Œè¿™æ˜¯æ— æ‰€è°“çš„ã€‚æ¯”å¦‚ä¸¤ä¸ªçº¿ç¨‹éƒ½è¦å¾€æ ‡å‡†è¾“å‡ºè¾“å‡ºä¸€æ®µå­—ç¬¦ï¼Œè°å…ˆè°åå¹¶ä¸ä¼šæœ‰ä»€ä¹ˆå¤ªå¤§å½±å“ã€‚

```cpp
void f() { std::cout << "â¤ï¸\n"; }
void f2() { std::cout << "ğŸ˜¢\n"; }

int main(){
    std::thread t{ f };
    std::thread t2{ f2 };
    t.join();
    t2.join();
}
```

> [`std::cout`](https://zh.cppreference.com/w/cpp/io/cout) çš„å•ä¸ª operator<< è°ƒç”¨æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸ä¼šè¢«æ‰“æ–­ã€‚

åªæœ‰åœ¨æ¶‰åŠå¤šçº¿ç¨‹ä¿®æ”¹ç›¸åŒå…±äº«æ•°æ®çš„æ—¶å€™ï¼Œæ‰ä¼šå¯¼è‡´â€œ*æ¶æ€§çš„æ¡ä»¶ç«äº‰*â€ã€‚

```cpp
std::vector<int>v;

void f() { v.emplace_back(1); }
void f2() { v.erase(v.begin()); }

int main() {
    std::thread t{ f };
    std::thread t2{ f2 };
    t.join();
    t2.join();
    std::cout << v.size() << '\n';
}
```

æ¯”å¦‚è¿™æ®µä»£ç å°±æ˜¯å…¸å‹çš„æ¶æ€§æ¡ä»¶ç«äº‰ï¼Œä¸¤ä¸ªçº¿ç¨‹å…±äº«ä¸€ä¸ª `vector`ï¼Œå¹¶å¯¹å®ƒè¿›è¡Œä¿®æ”¹ã€‚å¯èƒ½å¯¼è‡´è®¸å¤šé—®é¢˜ï¼Œæ¯”å¦‚ `f2` å…ˆæ‰§è¡Œï¼Œæ­¤æ—¶ `vector` è¿˜æ²¡æœ‰å…ƒç´ ï¼Œå¯¼è‡´æŠ›å‡ºå¼‚å¸¸ã€‚åˆæˆ–è€… `f` æ‰§è¡Œäº†ä¸€åŠï¼Œè°ƒç”¨äº† `f2()`ï¼Œç­‰ç­‰ã€‚

å½“ç„¶äº†ï¼Œä¹Ÿæœ‰å¯èƒ½å…ˆæ‰§è¡Œ fï¼Œç„¶åæ‰§è¡Œ f2ï¼Œæœ€åæ‰“å°äº† 0ï¼Œç¨‹åºè€è€å®å®æ‰§è¡Œå®Œæ¯•ã€‚

ä½†æ˜¯æˆ‘ä»¬æ˜¾ç„¶ä¸èƒ½å¯„å¸Œæœ›äºè¿™ç§æ“ä½œç³»ç»Ÿçš„è°ƒåº¦ã€‚

è€Œä¸”å³ä½¿ä¸æ˜¯ä¸€ä¸ªæ·»åŠ å…ƒç´ ï¼Œä¸€ä¸ªåˆ é™¤å…ƒç´ ï¼Œå…¨æ˜¯ `emplace_back` æ·»åŠ å…ƒç´ ï¼Œä¹Ÿä¸€æ ·ä¼šæœ‰é—®é¢˜ï¼Œç”±äº std::vector ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„å®¹å™¨ï¼Œå› æ­¤å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å¹¶ä¿®æ”¹ v æ—¶ï¼Œå¯èƒ½ä¼šå‘ç”Ÿ[æœªå®šä¹‰çš„è¡Œä¸º](https://zh.cppreference.com/w/cpp/language/memory_model#.E7.BA.BF.E7.A8.8B.E4.B8.8E.E6.95.B0.E6.8D.AE.E7.AB.9E.E4.BA.89)ã€‚å…·ä½“æ¥è¯´ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å°è¯•å‘ v ä¸­æ·»åŠ å…ƒç´ æ—¶ï¼Œä½†æ˜¯ `emplace_back` å‡½æ•°å´æ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ï¼Œæ‰§è¡Œäº†ä¸€åŠï¼Œåˆå»æ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹ã€‚å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ç«äº‰ï¼Œä»è€Œå¼•å‘æœªå®šä¹‰çš„ç»“æœã€‚

>å½“æŸä¸ªè¡¨è¾¾å¼çš„æ±‚å€¼å†™å…¥æŸä¸ªå†…å­˜ä½ç½®ï¼Œè€Œå¦ä¸€æ±‚å€¼è¯»æˆ–ä¿®æ”¹åŒä¸€å†…å­˜ä½ç½®æ—¶ï¼Œç§°è¿™äº›**è¡¨è¾¾å¼å†²çª**ã€‚**æ‹¥æœ‰ä¸¤ä¸ªå†²çªçš„æ±‚å€¼çš„ç¨‹åºå°±æœ‰æ•°æ®ç«äº‰**ï¼Œé™¤é
>
>- ä¸¤ä¸ªæ±‚å€¼éƒ½åœ¨åŒä¸€çº¿ç¨‹ä¸Šï¼Œæˆ–è€…åœ¨åŒä¸€ä¿¡å·å¤„ç†å‡½æ•°ä¸­æ‰§è¡Œï¼Œæˆ–
>- ä¸¤ä¸ªå†²çªçš„æ±‚å€¼éƒ½æ˜¯åŸå­æ“ä½œï¼ˆè§ std::atomicï¼‰ï¼Œæˆ–
>- ä¸€ä¸ªå†²çªçš„æ±‚å€¼å‘ç”Ÿæ—©äºâ€Šå¦ä¸€ä¸ªï¼ˆè§ std::memory_orderï¼‰
>
>**å¦‚æœå‡ºç°æ•°æ®ç«äº‰ï¼Œé‚£ä¹ˆç¨‹åºçš„è¡Œä¸ºæœªå®šä¹‰ã€‚**

æ ‡é‡ç±»å‹ç­‰éƒ½åŒç†ï¼Œæœ‰*æ•°æ®ç«äº‰*ï¼Œæœªå®šä¹‰è¡Œä¸ºï¼š

```cpp
int cnt = 0;
auto f = [&]{cnt++;};
std::thread t1{f}, t2{f}, t3{f}; // æœªå®šä¹‰è¡Œä¸º
```

## ä½¿ç”¨äº’æ–¥é‡

æ¦‚å¿µä»æ¥ä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œç”¨ä¸€æ®µå¯¹æ¯”ä»£ç ä¸ºä½ ç›´è§‚çš„å±•ç¤ºäº’æ–¥é‡çš„ä½œç”¨ï¼š

```cpp
void f() {
    std::cout << std::this_thread::get_id() << '\n';
}

int main() {
    std::vector<std::thread>threads;
    for (std::size_t i = 0; i < 10; ++i)
        threads.emplace_back(f);

    for (auto& thread : threads)
        thread.join();
}
```

è¿™æ®µä»£ç ä½ å¤šæ¬¡[è¿è¡Œ](https://godbolt.org/z/K7hcYxec9)å®ƒä¼šå¾—åˆ°æ¯«æ— è§„å¾‹å’Œæ ¼å¼çš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨[äº’æ–¥é‡](https://zh.cppreference.com/w/cpp/thread/mutex)è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

```cpp
#include <mutex> // å¿…è¦æ ‡å¤´
std::mutex m;

void f() {
    m.lock();
    std::cout << std::this_thread::get_id() << '\n';
    m.unlock();
}

int main() {
    std::vector<std::thread>threads;
    for (std::size_t i = 0; i < 10; ++i)
        threads.emplace_back(f);

    for (auto& thread : threads)
        thread.join();
}
```

å½“å¤šä¸ªçº¿ç¨‹æ‰§è¡Œå‡½æ•° `f` çš„æ—¶å€™ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æˆåŠŸè°ƒç”¨ `lock()` ç»™äº’æ–¥é‡ä¸Šé”ï¼Œå…¶ä»–æ‰€æœ‰çš„çº¿ç¨‹ `lock()` çš„è°ƒç”¨å°†é˜»å¡æ‰§è¡Œï¼Œç›´è‡³è·å¾—é”ã€‚ç¬¬ä¸€ä¸ªè°ƒç”¨ `lock()` çš„çº¿ç¨‹å¾—ä»¥ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæ‰§è¡Œæˆ‘ä»¬çš„ `std::cout` è¾“å‡ºè¯­å¥ï¼Œä¸ä¼šæœ‰ä»»ä½•å…¶ä»–çš„çº¿ç¨‹æ‰“æ–­è¿™ä¸ªæ“ä½œã€‚ç›´åˆ°çº¿ç¨‹æ‰§è¡Œ `unlock()`ï¼Œå°±è§£é”äº†äº’æ–¥ä½“ã€‚

é‚£ä¹ˆå…¶ä»–çº¿ç¨‹æ­¤æ—¶ä¹Ÿå°±èƒ½å†æœ‰ä¸€ä¸ªæˆåŠŸè°ƒç”¨ `lock`...

> è‡³äºåˆ°åº•å“ªä¸ªçº¿ç¨‹æ‰ä¼šæˆåŠŸè°ƒç”¨ï¼Œè¿™ä¸ªæ˜¯ç”±æ“ä½œç³»ç»Ÿè°ƒåº¦å†³å®šçš„ã€‚

çœ‹ä¸€éæè¿°å°±å¯ä»¥äº†ï¼Œç®€è€Œè¨€ä¹‹ï¼Œè¢« `lock()` å’Œ `unlock()` åŒ…å«åœ¨å…¶ä¸­çš„ä»£ç ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹çš„æ‰§è¡Œæ‰€æ‰“æ–­ã€‚

ä¸è¿‡ä¸€èˆ¬ä¸æ¨èè¿™æ ·æ˜¾å¼çš„ `lock()` ä¸ `unlock()`ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ C++11 æ ‡å‡†åº“å¼•å…¥çš„â€œç®¡ç†ç±»â€ [`std::lock_guard`](https://zh.cppreference.com/w/cpp/thread/lock_guard)ï¼š

```cpp
void f() {
    std::lock_guard<std::mutex>lc{ m };
    std::cout << std::this_thread::get_id() << '\n';
}
```

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ`std::lock_guard` æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿå®ƒæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿé¦–å…ˆé¡¾åæ€ä¹‰ï¼Œè¿™æ˜¯ä¸€ä¸ªâ€œç®¡ç†ç±»â€æ¨¡æ¿ï¼Œç”¨æ¥ç®¡ç†äº’æ–¥é‡çš„ä¸Šé”ä¸è§£é”ï¼Œæˆ‘ä»¬æ¥çœ‹å®ƒçš„ [MSVC å®ç°](https://github.com/microsoft/STL/blob/8e2d724cc1072b4052b14d8c5f81a830b8f1d8cb/stl/inc/mutex#L452-L473)ï¼š

```cpp
_EXPORT_STD template <class _Mutex>
class _NODISCARD_LOCK lock_guard { // class with destructor that unlocks a mutex
public:
    using mutex_type = _Mutex;

    explicit lock_guard(_Mutex& _Mtx) : _MyMutex(_Mtx) { // construct and lock
        _MyMutex.lock();
    }

    lock_guard(_Mutex& _Mtx, adopt_lock_t) noexcept // strengthened
        : _MyMutex(_Mtx) {} // construct but don't lock

    ~lock_guard() noexcept {
        _MyMutex.unlock();
    }

    lock_guard(const lock_guard&)            = delete;
    lock_guard& operator=(const lock_guard&) = delete;

private:
    _Mutex& _MyMutex;
};
```

è¿™æ®µä»£ç æå…¶ç®€å•ï¼Œé¦–å…ˆç®¡ç†ç±»ï¼Œè‡ªç„¶ä¸å¯ç§»åŠ¨ä¸å¯å¤åˆ¶ï¼Œæˆ‘ä»¬å®šä¹‰äº†å¤åˆ¶æ„é€ å¤åˆ¶èµ‹å€¼ä¸º[å¼ƒç½®å‡½æ•°](https://zh.cppreference.com/w/cpp/language/function#.E5.BC.83.E7.BD.AE.E5.87.BD.E6.95.B0)ï¼ŒåŒæ—¶[é˜»æ­¢](https://zh.cppreference.com/w/cpp/language/rule_of_three#.E4.BA.94.E4.B9.8B.E6.B3.95.E5.88.99)äº†ç§»åŠ¨ç­‰å‡½æ•°çš„éšå¼å®šä¹‰ã€‚

å®ƒåªä¿æœ‰ä¸€ä¸ªç§æœ‰æ•°æ®æˆå‘˜ï¼Œä¸€ä¸ªå¼•ç”¨ï¼Œç”¨æ¥å¼•ç”¨äº’æ–¥é‡ã€‚

æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–è¿™ä¸ªå¼•ç”¨ï¼ŒåŒæ—¶ä¸Šé”ï¼Œææ„å‡½æ•°ä¸­è§£é”ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å…¸å‹çš„ `RAII` å¼çš„ç®¡ç†ã€‚

åŒæ—¶å®ƒè¿˜æä¾›ä¸€ä¸ªæœ‰é¢å¤–[`adopt_lock_t`](https://zh.cppreference.com/w/cpp/thread/lock_tag_t)å‚æ•°çš„æ„é€ å‡½æ•° ï¼Œå¦‚æœä½¿ç”¨è¿™ä¸ªæ„é€ å‡½æ•°ï¼Œåˆ™æ„é€ ä¸ä¼šä¸Šé”ã€‚

æ‰€ä»¥æœ‰çš„æ—¶å€™ä½ å¯èƒ½ä¼šçœ‹åˆ°ä¸€äº›è¿™æ ·çš„ä»£ç ï¼š

```cpp
void f(){
    //code..
    {
        std::lock_guard<std::mutex>lc{ m };
        // æ¶‰åŠå…±äº«èµ„æºçš„ä¿®æ”¹çš„ä»£ç ...
    }
    //code..
}
```

ä½¿ç”¨ `{}` åˆ›å»ºäº†ä¸€ä¸ªå—ä½œç”¨åŸŸï¼Œé™åˆ¶äº†å¯¹è±¡ `lc` çš„ç”Ÿå­˜æœŸï¼Œè¿›å…¥ä½œç”¨åŸŸæ„é€  `lock_guard` çš„æ—¶å€™ä¸Šé”ï¼ˆlockï¼‰ï¼Œç¦»å¼€ä½œç”¨åŸŸææ„çš„æ—¶å€™è§£é”ï¼ˆunlockï¼‰ã€‚

- æˆ‘ä»¬è¦å°½å¯èƒ½çš„è®©äº’æ–¥é‡ä¸Šé”çš„**ç²’åº¦**å°ï¼Œåªç”¨æ¥ç¡®ä¿å¿…é¡»çš„å…±äº«èµ„æºçš„çº¿ç¨‹å®‰å…¨ã€‚

> â€œ**ç²’åº¦**â€é€šå¸¸ç”¨äºæè¿°é”å®šçš„èŒƒå›´å¤§å°ï¼Œè¾ƒå°çš„ç²’åº¦æ„å‘³ç€é”å®šçš„èŒƒå›´æ›´å°ï¼Œå› æ­¤æœ‰æ›´å¥½çš„æ€§èƒ½å’Œæ›´å°‘çš„ç«äº‰ã€‚

æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­ï¼š

```cpp
std::mutex m;

void add_to_list(int n, std::list<int>& list) {
    std::vector<int> numbers(n + 1);
    std::iota(numbers.begin(), numbers.end(), 0);
    int sum = std::accumulate(numbers.begin(), numbers.end(), 0);

    {
        std::lock_guard<std::mutex>lc{ m };
        list.push_back(sum);
    }
}
void print_list(const std::list<int>& list){
    std::lock_guard<std::mutex>lc{ m };
    for(const auto& i : list){
        std::cout << i << ' ';
    }
    std::cout << '\n';
}
```

```cpp
std::list<int>list;
std::thread t1{ add_to_list,i,std::ref(list) };
std::thread t2{ add_to_list,i,std::ref(list) };
std::thread t3{ print_list,std::cref(list) };
std::thread t4{ print_list,std::cref(list) };
t1.join();
t2.join();
t3.join();
t4.join();
```

> å®Œæ•´ä»£ç æµ‹è¯•ã€‚

å…ˆçœ‹ `add_to_list`ï¼Œåªæœ‰ `list.push_back(sum)` æ¶‰åŠåˆ°äº†å¯¹å…±äº«æ•°æ®çš„ä¿®æ”¹ï¼Œéœ€è¦è¿›è¡Œä¿æŠ¤ï¼Œæˆ‘ä»¬ç”¨ `{}` åŒ…èµ·æ¥äº†ã€‚

å‡è®¾æœ‰çº¿ç¨‹ Aã€Bæ‰§è¡Œå‡½æ•° `add_to_list()` ï¼šçº¿ç¨‹ A ä¸­çš„ numbersã€sum ä¸çº¿ç¨‹ B ä¸­çš„ï¼Œä¸æ˜¯åŒä¸€ä¸ªï¼Œå¸Œæœ›å¤§å®¶åˆ†æ¸…æ¥šï¼Œè‡ªç„¶ä¸å­˜åœ¨æ•°æ®ç«äº‰ï¼Œä¹Ÿä¸éœ€è¦ä¸Šé”ã€‚çº¿ç¨‹ Aã€Bæ‰§è¡Œå®Œäº†å‰é¢æ±‚ `0-n` çš„è®¡ç®—ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½åœ¨ `lock_guard` çš„æ„é€ å‡½æ•°ä¸­æˆåŠŸè°ƒç”¨ lock() ç»™äº’æ–¥é‡ä¸Šé”ã€‚å‡è®¾çº¿ç¨‹ A æˆåŠŸè°ƒç”¨ lock()ï¼Œé‚£ä¹ˆçº¿ç¨‹ B çš„ lock() è°ƒç”¨å°±é˜»å¡äº†ï¼Œå¿…é¡»ç­‰å¾…çº¿ç¨‹ A æ‰§è¡Œå®Œé‡Œé¢çš„ä»£ç ï¼Œç„¶åä½œç”¨åŸŸç»“æŸï¼Œè°ƒç”¨ `lock_guard` çš„ææ„å‡½æ•°ï¼Œè§£é” unlock()ï¼Œæ­¤æ—¶çº¿ç¨‹ B å°±å¯ä»¥è¿›å»æ‰§è¡Œäº†ï¼Œé¿å…äº†æ•°æ®ç«äº‰ï¼Œä¸å­˜åœ¨ä¸€ä¸ªå¯¹è±¡åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹ä¿®æ”¹ã€‚

å‡½æ•° `print_list()` å°±æ›´ç®€å•äº†ï¼Œæ‰“å° `list`ï¼Œç»™æ•´ä¸ªå‡½æ•°ä¸Šé”ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚

æˆ‘ä»¬çš„ä½¿ç”¨ä»£ç æ˜¯å¤šä¸ªçº¿ç¨‹æ‰§è¡Œè¿™ä¸¤ä¸ªå‡½æ•°ï¼Œä¸¤ä¸ªå‡½æ•°å…±äº«äº†ä¸€ä¸ªé”ï¼Œè¿™æ ·ç¡®ä¿äº†å½“æ‰§è¡Œå‡½æ•° `print_list()` æ‰“å°çš„æ—¶å€™ï¼Œlist çš„çŠ¶æ€æ˜¯ç¡®å®šçš„ã€‚æ‰“å°å‡½æ•° `print_list` å’Œ `add_to_list` å‡½æ•°çš„ä¿®æ”¹æ“ä½œåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œã€‚`print_list()` ä¸å¯èƒ½çœ‹åˆ°æ­£åœ¨è¢«`add_to_list()` ä¿®æ”¹çš„ listã€‚

è‡³äºåˆ°åº•å“ªä¸ªå‡½æ•°å“ªä¸ªçº¿ç¨‹ä¼šå…ˆæ‰§è¡Œï¼Œæ‰§è¡Œå¤šå°‘æ¬¡ï¼Œè¿™äº›éƒ½ç”±æ“ä½œç³»ç»Ÿè°ƒåº¦å†³å®šï¼Œä¹Ÿå®Œå…¨æœ‰å¯èƒ½**è¿ç»­ 4 æ¬¡**éƒ½æ˜¯æ‰§è¡Œå‡½æ•° `print_list` çš„çº¿ç¨‹æˆåŠŸè°ƒç”¨ `lock`ï¼Œä¼šæ‰“å°å‡ºäº†ä¸€æ ·çš„å€¼ï¼Œè¿™éƒ½å¾ˆæ­£å¸¸ã€‚

---

C++17 æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ç‰¹æ€§ï¼Œç±»æ¨¡æ¿å®å‚æ¨å¯¼ï¼Œ `std::lock_guard` å¯ä»¥æ ¹æ®ä¼ å…¥çš„å‚æ•°è‡ªè¡Œæ¨å¯¼ï¼Œè€Œä¸éœ€è¦å†™æ˜æ¨¡æ¿ç±»å‹å‚æ•°ï¼š

```cpp
std::mutex m;
std::lock_guard lc{ m }; // std::lock_guard<std::mutex>
```

å¹¶ä¸” C++17 è¿˜å¼•å…¥äº†ä¸€ä¸ªæ–°çš„â€œç®¡ç†ç±»â€ï¼š[`std::scoped_lock`](https://zh.cppreference.com/w/cpp/thread/scoped_lock)ï¼Œå®ƒç›¸è¾ƒäº `lock_guard`çš„åŒºåˆ«åœ¨äºï¼Œå®ƒå¯ä»¥ç®¡ç†å¤šä¸ªäº’æ–¥é‡ã€‚ä¸è¿‡å¯¹äºå¤„ç†ä¸€ä¸ªäº’æ–¥é‡çš„æƒ…å†µï¼Œå®ƒå’Œ `lock_guard` å®Œå…¨ç›¸åŒã€‚

```cpp
std::mutex m;
std::scoped_lock lc{ m }; // std::scoped_lock<std::mutex>
```

- [**`std::scoped_lock` çš„æºç å®ç°ä¸è§£æ**](md/è¯¦ç»†åˆ†æ/02scoped_lockæºç è§£æ.md)

## ä¿æŠ¤å…±äº«æ•°æ®

äº’æ–¥é‡ä¸»è¦ä¹Ÿå°±æ˜¯ä¸ºäº†ä¿æŠ¤å…±äº«æ•°æ®ï¼Œä¸Šä¸€èŠ‚çš„*ä½¿ç”¨äº’æ–¥é‡*ä¹Ÿå·²ç»ä¸ºå„ä½å±•ç¤ºäº†ä¸€äº›ã€‚
